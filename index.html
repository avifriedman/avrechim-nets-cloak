<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>שעון דיגיטלי</title>
  <style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: black;
      color: lime;
      font-family: 'Courier New', monospace;
      flex-direction: column;
    }
    #clock {
      font-size: 10vw;
      font-weight: bold;
    }
    #countdown {
      font-size: 5vw;
      margin-top: 20px;
      display: none;
    }
    #dateRow {
      font-size: 2vw;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <div id="clock">00:00:00</div>
  <div id="countdown">00:00:00</div>
  <div id="dateRow"></div>

  <script>
    const CSV_PATH = './sunrise_times.csv'; 
    const DEFAULT_SUNRISE = '06:00:00';

    let sunriseMap = new Map(); 

    function parseCsv(text){
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length);
      if(lines.length === 0) return;
      let start = 0;
      if (/date/i.test(lines[0])) start = 1;
      for(let i=start;i<lines.length;i++){
        const cols = lines[i].split(',').map(c=>c.trim());
        if(cols.length < 3) continue;
        const date = cols[0];       // YYYY-MM-DD
        const hebrewDate = cols[1]; // למשל "ב' תשרי תשפ"ו"
        let sunrise = cols[2];      // HH:MM[:SS]
        if(/^\d{2}:\d{2}$/.test(sunrise)) sunrise += ':00';
        if(/^\d{4}-\d{2}-\d{2}$/.test(date)){
          sunriseMap.set(date,{sunrise,hebrew:hebrewDate});
        }
      }
    }

    function getDataForDate(dateObj){
      const key = dateObj.toISOString().slice(0,10);
      return sunriseMap.get(key) || {sunrise:DEFAULT_SUNRISE, hebrew:'—'};
    }

    function pad(n){return n.toString().padStart(2,'0');}

    function updateClock(){
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const data = getDataForDate(today);
      const sunriseStr = data.sunrise;
      const hebrewDate = data.hebrew;

      // שעון ראשי
      const h = pad(now.getHours()), m = pad(now.getMinutes()), s = pad(now.getSeconds());
      document.getElementById('clock').textContent = `${h}:${m}:${s}`;

      // חישוב ספירה לאחור
      const [sh,sm,ss] = sunriseStr.split(':').map(Number);
      const sunriseTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), sh, sm, ss);
      const oneHourBefore = new Date(sunriseTime.getTime() - 60*60*1000);

      const countdownEl = document.getElementById('countdown');
      if(now >= oneHourBefore && now < sunriseTime){
        const diff = sunriseTime - now;
        const cdH = pad(Math.floor(diff/3600000));
        const cdM = pad(Math.floor((diff%3600000)/60000));
        const cdS = pad(Math.floor((diff%60000)/1000));
        countdownEl.textContent = `${cdH}:${cdM}:${cdS}`;
        countdownEl.style.display = 'block';
      } else {
        countdownEl.style.display = 'none';
      }

      // תצוגת יום ותאריכים
      const days = ["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];
      const weekday = days[now.getDay()];
      const gregDate = `${now.getMonth()+1}/${now.getDate()}/${now.getFullYear()}`;
      document.getElementById('dateRow').textContent = `${weekday} ${hebrewDate} | ${gregDate}`;
    }

    fetch(CSV_PATH)
      .then(r=>r.text())
      .then(t=>{
        parseCsv(t);
        setInterval(updateClock,1000);
        updateClock();
      })
      .catch(e=>{
        console.error("CSV load error", e);
        setInterval(updateClock,1000);
        updateClock();
      });
  </script>
</body>
</html>
