<!doctype html>
<html lang="he">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>שעון</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b1220;
    --accent:#00ffcc;
    --muted:#9fb4c4;
    --digital-font: 'Roboto Mono', monospace;
  }
  body{
    margin:0;
    min-height:100vh;
    display:flex;
    flex-direction: column;
    align-items:center;
    justify-content:center;
    background:linear-gradient(180deg,#031026 0%, #071629 100%);
    color:var(--accent);
    font-family:var(--digital-font);
    direction:rtl;
    text-align: center;
    overflow: hidden;
  }

  .fixed-width-digits {
    font-variant-numeric: tabular-nums;
    font-feature-settings: "tnum";
  }

  #defaultDisplay {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
  }

  #mainDisplay {
    font-size: 15vw;
    letter-spacing: 0.05em;
    line-height: 1;
    color: var(--accent);
    text-shadow: 0 0 15px rgba(0, 255, 204, 0.5);
  }

  #subDisplay {
    font-size: 3vw;
    color: var(--muted);
    margin-top: 2vh;
  }

  #countdownArea {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    color: #fff;
  }

  #countdown {
    font-size: 15vw;
    letter-spacing: 0.05em;
    line-height: 1;
    background: rgba(0,255,204,0.08);
    padding: 0.5em 1em;
    border-radius: 12px;
    text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
  }

  .countdown-info {
    margin-top: 3vh;
    font-size: 3vw;
    color: var(--muted);
    line-height: 1.5;
  }
  .countdown-info div {
    margin: 0.5vh 0;
  }

  /* --- Responsive Adjustments for Mobile Screens --- */
  @media(max-width:768px){
    #mainDisplay, #countdown {
      font-size: 20vw;
    }
    #subDisplay, .countdown-info {
      font-size: 4.5vw;
    }
  }
  @media(max-width:480px){
    #mainDisplay, #countdown {
      font-size: 25vw;
    }
    #subDisplay, .countdown-info {
      font-size: 5.5vw;
    }
  }

  /* --- NEW: Responsive Adjustments for Ultra-Wide Screens --- */
  /* This targets screens that are at least 3 times wider than they are tall */
  @media (min-aspect-ratio: 3/1) {
    #mainDisplay, #countdown {
      /* Use vh (viewport height) so the font scales with the shorter dimension */
      font-size: 40vh;
    }
    #subDisplay, .countdown-info {
      font-size: 8vh;
    }
  }

</style>
</head>
<body>
  <div id="defaultDisplay">
    <div id="mainDisplay" class="fixed-width-digits">--:--:--</div>
    <div id="subDisplay">--</div>
  </div>

  <div id="countdownArea">
    <div id="countdown" class="fixed-width-digits">00:00:00</div>
    <div class="countdown-info">
      <div>שעה נוכחית: <span id="nowSmall" class="fixed-width-digits">--:--:--</span></div>
      <div>שעת הנץ: <span id="sunriseSmall" class="fixed-width-digits">--:--:--</span></div>
    </div>
  </div>

<script>
const CSV_PATH = './sunrise_times.csv';
const VERSION_FILE_PATH = './version.json';
const DEFAULT_SUNRISE = '06:00:00';
const VERSION_CHECK_INTERVAL_MS = 5 * 60 * 1000;

let sunriseMap = new Map();
let currentDataVersion = 0;

function z(n,len=2){return String(n).padStart(len,'0');}

async function loadCsv(){
  try{
    const res = await fetch(CSV_PATH + '?cache=' + new Date().getTime());
    if(!res.ok) throw new Error('CSV fetch error: ' + res.statusText);
    const txt = await res.text();
    parseCsv(txt);
    console.log("CSV data loaded successfully.");
    return true;
  }catch(e){
    console.warn("בעיה בטעינת CSV",e);
    return false;
  }
}

function parseCsv(text){
  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length);
  if(lines.length === 0) return;
  let start = 0;
  if (/date/i.test(lines[0])) start = 1;

  sunriseMap.clear();

  for(let i=start;i<lines.length;i++){
    const cols = lines[i].split(',').map(c=>c.trim());
    if(cols.length < 3) continue;

    const date = cols[0];
    const hebrew = cols[1];
    let sunrise = cols[2];

    if(/^\d{2}:\d{2}$/.test(sunrise)) sunrise += ':00';

    if(/^\d{4}-\d{2}-\d{2}$/.test(date)){
      sunriseMap.set(date,{sunrise,hebrew});
    }
  }
}

function getDataForDate(dateObj){
  const year = dateObj.getFullYear();
  const month = z(dateObj.getMonth() + 1);
  const day = z(dateObj.getDate());
  const key = `${year}-${month}-${day}`;

  return sunriseMap.get(key) || {sunrise:DEFAULT_SUNRISE, hebrew:'—'};
}

function formatTime(d){
  return z(d.getHours())+":"+z(d.getMinutes())+":"+z(d.getSeconds());
}

function updateTick(){
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  const data = getDataForDate(today);
  
  const hebrewDate = data.hebrew;
  const [sh,sm,ss] = data.sunrise.split(':').map(n=>parseInt(n,10));

  const sunrise = new Date(today.getFullYear(), today.getMonth(), today.getDate(), sh, sm, ss||0);
  const switchStart = new Date(sunrise.getTime() - 3600000);

  const defaultDisplay = document.getElementById('defaultDisplay');
  const countdownArea = document.getElementById('countdownArea');
  const mainDisplay = document.getElementById('mainDisplay');
  const subDisplay = document.getElementById('subDisplay');

  const wd = new Intl.DateTimeFormat('he-IL',{weekday:'long'}).format(now);

  if(now >= switchStart && now < sunrise){
    defaultDisplay.style.display = 'none';
    countdownArea.style.display = 'flex';

    const diff = Math.max(0, Math.floor((sunrise - now) / 1000));
    const hh = Math.floor(diff / 3600);
    const mm = Math.floor((diff % 3600) / 60);
    const ss2 = diff % 60;

    document.getElementById('countdown').textContent = z(hh)+":"+z(mm)+":"+z(ss2);
    document.getElementById('nowSmall').textContent = formatTime(now);
    document.getElementById('sunriseSmall').textContent = z(sh)+":"+z(sm)+":"+z(ss || 0);

  } else {
    defaultDisplay.style.display = 'flex';
    countdownArea.style.display = 'none';

    mainDisplay.textContent = formatTime(now);
    subDisplay.textContent = wd + " • " + hebrewDate;
  }
}

async function checkForNewVersion(){
  try {
    const res = await fetch(VERSION_FILE_PATH + '?cache=' + new Date().getTime());
    if (!res.ok) throw new Error('Version file fetch error: ' + res.statusText);
    const versionData = await res.json();
    const latestVersion = versionData.last_updated || 0;

    if (latestVersion > currentDataVersion) {
      console.log(`New data version detected: ${latestVersion}. Current: ${currentDataVersion}. Reloading CSV.`);
      const loaded = await loadCsv();
      if (loaded) {
        currentDataVersion = latestVersion;
        console.log("CSV data updated from new version.");
      }
    }
  } catch (e) {
    console.warn("בעיה בבדיקת גרסה או טעינת נתונים חדשים", e);
  }
}

(async function init(){
  const loaded = await loadCsv();
  if (loaded) {
    try {
      const res = await fetch(VERSION_FILE_PATH + '?cache=' + new Date().getTime());
      if (res.ok) {
        const versionData = await res.json();
        currentDataVersion = versionData.last_updated || 0;
        console.log(`Initial data version set to: ${currentDataVersion}`);
      }
    } catch (e) {
      console.warn("Could not retrieve initial version from version.json", e);
    }
  }

  updateTick();
  setInterval(updateTick,1000);

  setInterval(checkForNewVersion, VERSION_CHECK_INTERVAL_MS);
})();
</script>
</body>
</html>
